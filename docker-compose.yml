# ██████████████████████████████████████████████████████████████████████████████
# █                                                                            █
# █   ███╗   ██╗ ██████╗ ██████╗ ██████╗     ██╗  ██╗███████╗██╗     ██╗       █
# █   ████╗  ██║██╔═══██╗██╔══██╗██╔══██╗    ██║  ██║██╔════╝██║     ██║       █
# █   ██╔██╗ ██║██║   ██║██████╔╝██║  ██║    ███████║█████╗  ██║     ██║       █
# █   ██║╚██╗██║██║   ██║██╔══██╗██║  ██║    ██╔══██║██╔══╝  ██║     ██║       █
# █   ██║ ╚████║╚██████╔╝██║  ██║██████╔╝    ██║  ██║███████╗███████╗███████╗  █
# █   ╚═╝  ╚═══╝ ╚═════╝ ╚═╝  ╚═╝╚═════╝     ╚═╝  ╚═╝╚══════╝╚══════╝╚══════╝  █
# █                                                                            █   
# ██████████████████████████████████████████████████████████████████████████████
name: nordhell
services:
  nordhell-passage:
    build:
      context: .
    image: passage-${VPN_CONFIG_NUM:-0}:latest
    container_name: passage-${VPN_CONFIG_NUM:-0}
    networks:
      - nordhell-network
    env_file:
      - .env
    environment:
      - VPN_CONFIG_NUM=${VPN_CONFIG_NUM:-0}
      - SOCKS_BASE_PORT=${SOCKS_BASE_PORT:-1080}
      - SOCKS_MAX_PORT=${SOCKS_MAX_PORT:-1180}
      - VPN_USERNAME=${VPN_USERNAME}
      - VPN_PASSWORD=${VPN_PASSWORD}
    volumes:
      - ./vpn-configs:/etc/openvpn/vpn-configs:ro
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "${SOCKS_PORT:-${SOCKS_BASE_PORT:-1080}}:1080"
    restart: unless-stopped
    init: true
    dns:
      - 1.1.1.1
      - 8.8.8.8
    healthcheck:
      test: ["CMD", "sh", "-c", "nc -z 127.0.0.1 1080 && ip link show tun0"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  nordhell-network:
    name: nordhell-network
    external: true