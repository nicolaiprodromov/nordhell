services:
  llustr-proxy-tunnel:
    build:
      context: .
      args:
        - VPN_CONFIG_NUM=${VPN_CONFIG_NUM:-0}
    image: llustr-proxy-tunnel-${VPN_CONFIG_NUM:-0}
    container_name: llustr-proxy-tunnel-${VPN_CONFIG_NUM:-0}
    networks:
      - llustr-proxy-network
    env_file:
      - .env
    environment:
      - VPN_CONFIG_NUM=${VPN_CONFIG_NUM:-0}
    tmpfs:
      - /run/vpn-credentials:size=1M,mode=700,noexec,nosuid
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "${SOCKS_PORT:-1080}:1080"
    restart: unless-stopped
    init: true
    dns:
      - 1.1.1.1
      - 8.8.8.8
    healthcheck:
      test: ["CMD", "sh", "-c", "nc -z 127.0.0.1 1080 && ip link show tun0"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  llustr-proxy-network:
    name: llustr-proxy-network